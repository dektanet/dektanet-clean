<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
</head>
<body>

<h2>Dashboard</h2>

<p>DEKTA: <span id="dekta">0</span></p>
<p>DEKTA-BOX: <span id="boxBalance">30</span></p>

<p>Status: <b id="status">INACTIVE</b></p>

<button id="activateBtn">Activate BOX (30 DEKTA)</button>
<br><br>
<button id="logoutBtn">Logout</button>

<script type="module">
  import { auth, db } from "./js/firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const statusEl = document.getElementById("status");
  const activateBtn = document.getElementById("activateBtn");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);

    if (!snap.exists()) return;

    const data = snap.data();

    if (data.box?.status === "active") {
      statusEl.textContent = "ACTIVE";
      activateBtn.style.display = "none";
    }
  });

  activateBtn.onclick = async () => {
    const user = auth.currentUser;
    if (!user) return;

    const userRef = doc(db, "users", user.uid);

    const now = new Date();
    const expires = new Date();
    expires.setDate(now.getDate() + 30);

    await updateDoc(userRef, {
      "box.status": "active",
      "box.activatedAt": serverTimestamp(),
      "box.expiresAt": expires
    });

    alert("BOX Activated âœ… (30 days)");

    statusEl.textContent = "ACTIVE";
    activateBtn.style.display = "none";
  };

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    localStorage.clear();
    sessionStorage.clear();
    window.location.href = "login.html";
  };
</script>

</body>
</html>
